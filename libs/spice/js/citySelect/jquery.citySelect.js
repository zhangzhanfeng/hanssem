/**
 *
 * 省市区联动效果
 * 详细用法请参考：http://v3.spice.lh/javascript/citySelect
 * 如果链接无法访问，请联系QQ：1515110755 或 RTX：hong.liang
 *
 * @ author Razy
 * @ version 1.1
 *
 */
!function(a,b,c){"object"==typeof module&&"object"==typeof module.exports?module.exports=b(a):a.spice.citySelect=b(a)}(jQuery,function(a){function b(b,c){if(!b||a.isPlainObject(b))return!1;var d=[];return a(b).each(function(b,f){var g=a(f),h=g.data("spice.citySelect");h||g.data("spice.citySelect",h=new e(g,c)),d.push(h)}),d}var c={defaultText:["省份/直辖市","市","县/区"],defaultDataObj:window.districtJson,defaultDataStart:"1",btnClass:null,btnAddClass:"open",contentClass:null,callBack:null,defaultError:!0,tinyscrollbarCallBack:null,tinyscrollbarConfig:{},customScroll:null,isIscroll:!1},d={getPCDObj:function(b,c){return b&&!a.isEmptyObject(c.defaultDataObj[b])?c.defaultDataObj[b]:{}},getDefaultSelectVal:function(b){return a.map(a("select",b),function(b){var c=a("option:selected",b);return c.attr("value")+"-"+c.text()})},defaultSelect:function(b,c){var e=c.opt,f=c.elem;b.on("change",function(b,g){var h=a(this),i=h.prev(".btn"),j=+h.attr("city-index"),k=a("option:selected",h).attr("value"),l=a("option:selected",h).text();h.removeAttr("city-curval"),0!=i.length&&a("span:eq(0)",i).html(l),e.defaultError&&!g&&(k?(0!=i.length?i.closest(".form-select"):h).removeClass("is-error").addClass("is-success"):(0!=i.length?i.closest(".form-select"):h).addClass("is-error").removeClass("is-success"),c.elem[-1==a.inArray(!0,c.isError())?"removeClass":"addClass"]("is-error"),c.elem[-1==a.inArray(!0,c.isError())?"addClass":"removeClass"]("is-success"));var m=d.getPCDObj(k,e),n=a("[city-index="+ ++j+"]",f),o=n.attr("city-curval");if(0==n.length)return e.callBack&&a.isFunction(e.callBack)&&e.callBack(d.getDefaultSelectVal(f),f,g),!1;n.removeAttr("city-curval").html(d.getOptionHtml(j,m,o,c)).trigger("change",[g])})},hide:function(b){var c=a(".sub-menu",".form-select");c.hide(),c.prev().removeClass(b)},getSimulationSelectVal:function(b,c){return a.map(a(b.contentClass,c),function(b){var c=a("li.selected",b);return c.attr("city-value")+"-"+c.text()})},simulationSelect:function(b,c){var e=c.opt,f=c.elem,g=+b.attr("city-index"),h=c.pcdBtn.eq(g);h.on("tap",function(c){c.preventDefault();var f=b.closest(".sub-menu"),g=e.tinyscrollbarConfig,i=e.customScroll;if(f.is(":visible"))return d.hide(e.btnAddClass),!1;d.hide(e.btnAddClass),h.addClass(e.btnAddClass),f.show(),i?a.isFunction(i)&&i($self):(g.callBack||(g.callBack=function(b){e.tinyscrollbarCallBack&&a.isFunction(e.tinyscrollbarCallBack)&&e.tinyscrollbarCallBack($self,b)}),a.spice.tools.tinyscrollbar({elem:f,options:g,isIscroll:e.isIscroll}))}),b.on("tap","li",function(b,g){b.preventDefault();var h=a(this),i=h.parent(),j=+i.attr("city-index"),k=h.attr("city-value");h.addClass("selected").siblings().removeClass("selected"),i.removeAttr("city-curval");var l=a("span:eq(0)",h.closest(".sub-menu").prev());if(l.html()==k)return d.hide(e.btnAddClass),!1;e.defaultError&&!g&&(k?h.closest(".form-select").removeClass("is-error").addClass("is-success"):h.closest(".form-select").addClass("is-error").removeClass("is-success"),c.elem[-1==a.inArray(!0,c.isError())?"removeClass":"addClass"]("is-error"),c.elem[-1==a.inArray(!0,c.isError())?"addClass":"removeClass"]("is-success")),l.html(h.text()),d.hide(e.btnAddClass);var m=d.getPCDObj(k,e),n=a("[city-index="+ ++j+"]",f),o=n.attr("city-curval");if(0==n.length)return e.callBack&&a.isFunction(e.callBack)&&e.callBack(d.getSimulationSelectVal(e,f),f,g),!1;n.html(d.getOptionHtml(j,m,o,c));var p=a("li.selected",n);0==p.length&&(p=a("li:eq(0)",n)),p.trigger("tap",[g])})},activate:function(a,b){b.isDefault?d.defaultSelect(a,b):d.simulationSelect(a,b)},getOptionHtml:function(b,c,d,e){if(e.isDefault){var f=e.opt.defaultText?'<option value="">'+(e.opt.defaultText[b]||"")+"</option>":"";a.each(c,function(a,b){f+='<option value="'+a+'" '+(a==d||b==d?"selected":"")+" >"+b+"</option>"})}else{var f=e.opt.defaultText?'<li city-value=""><a>'+(e.opt.defaultText[b]||"")+"</a></li>":"";a.each(c,function(a,b){f+="<li"+(a==d||b==d?' class="selected"':"")+' city-value="'+a+'" ><a>'+b+"</a></li>"})}return f}},e=function(b,d){var e=this;e.opt=a.extend({},c,d),e.elem=b,e.init()};return e.prototype={init:function(){var b=this,c=b.opt;if(!c.defaultDataObj||a.isEmptyObject(c.defaultDataObj))return!1;var e=b.isDefault=!(c.btnClass&&c.contentClass);if(e?b.select=a("select",b.elem):(b.select=a(c.contentClass,b.elem),b.pcdBtn=a(c.btnClass,b.elem)),0==b.select.length)return!1;if(a.each(b.select,function(e,f){var g=a(f),h=g.attr("city-curval");g.attr({"city-index":e}).html(d.getOptionHtml(e,0==e?c.defaultDataObj[c.defaultDataStart]:{},h,b)),d.activate(g,b)}),e)b.select.eq(0).trigger("change",["default"]);else{var f=a("li.selected",b.select.eq(0));0==f.length&&(f=a("li:eq(0)",b.select.eq(0))),f.trigger("tap",["default"]),a("html").on("tap",function(b){var e=a(b.target);e.hasClass("form-select")||0!=e.parents(".form-select").length||d.hide(c.btnAddClass)})}},getSelectVal:function(){return this.isDefault?d.getDefaultSelectVal(this.elem):d.getSimulationSelectVal(this.opt,this.elem)},setSelectVal:function(b){if(!a.isArray(b)||0==b.length)return!1;if(this.select){this.select.attr("city-curval",function(){return b[a(this).attr("city-index")]});var c=null;this.isDefault?(a("option",this.select.eq(0)).removeAttr("selected"),c=a("option:contains("+b[0]+")",this.select.eq(0)),0===c.length&&(c=a("option[value="+b[0]+"]",this.select.eq(0))),c.attr("selected","selected"),this.select.eq(0).trigger("change",["default"])):(a("li",this.select.eq(0)).removeAttr("class"),c=a("li:contains("+b[0]+")",this.select.eq(0)),0===c.length&&(c=a("li[city-value="+b[0]+"]",this.select.eq(0))),c.addClass("selected").trigger("tap",["default"]))}},isError:function(){var b=[];return a.each(this.getSelectVal(),function(a,c){b.push(!c.split("-")[0])}),b}},b});
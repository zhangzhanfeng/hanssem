/**
 *
 * 省市区联动效果
 * 详细用法请参考：http://v3.spice.lh/javascript/ymdSelect
 * 如果链接无法访问，请联系QQ：1515110755 或 RTX：hong.liang
 *
 * @ author Razy
 * @ version 1.0
 *
 */
!function(a){"use strict";function b(b,c){if(!b||a.isPlainObject(b))return!1;var d=[];return a(b).each(function(b,f){var g=a(f),h=g.data("spice.ymdSelect");h||g.data("spice.ymdSelect",h=new e(g,c)),d.push(h)}),d}var c={defaultText:["年","月","日"],btnClass:null,contentClass:null,btnAddClass:"open",year:[1900,2016],callBack:null,defaultError:!0,tinyscrollbarCallBack:null,tinyscrollbarConfig:{},customScroll:null,isIscroll:!1},d={defaultSelect:function(b,c){var e=c.opt,f=c.elem;b.on("change",function(b,g){var h=a(this),i=h.prev(".btn"),j=+h.attr("ymd-index"),k=a("option:selected",h).attr("value"),l=a("option:selected",h).text();h.removeAttr("ymd-curval"),0!=i.length&&a("span:eq(0)",i).html(l),e.defaultError&&!g&&(k?(0!=i.length?i.closest(".form-select"):h).removeClass("is-error").addClass("is-success"):(0!=i.length?i.closest(".form-select"):h).addClass("is-error").removeClass("is-success"),c.elem[-1==a.inArray(!0,c.isError())?"removeClass":"addClass"]("is-error"),c.elem[-1==a.inArray(!0,c.isError())?"addClass":"removeClass"]("is-success")),++j;var m=a("[ymd-index="+j+"]",f),n=m.attr("ymd-curval");if(0==m.length)return e.callBack&&a.isFunction(e.callBack)&&e.callBack(d.getDefaultSelectVal(f),f,g),!1;m.removeAttr("ymd-curval").html(d.getOptionHtml(j,n,c)).trigger("change",[g])})},hide:function(b){var c=a(".sub-menu",".form-select");c.hide(),c.prev().removeClass(b)},getSimulationSelectVal:function(b,c){return a.map(a(b.contentClass,c),function(b){return a("li.selected",b).attr("ymd-value")})},simulationSelect:function(b,c){var e=c.opt,f=c.elem,g=+b.attr("ymd-index"),h=c.pcdBtn.eq(g);h.on("tap",function(){var c=b.closest(".sub-menu"),f=e.tinyscrollbarConfig,g=e.customScroll;if(c.is(":visible"))return d.hide(e.btnAddClass),!1;d.hide(e.btnAddClass),h.addClass(e.btnAddClass),c.show(),g?a.isFunction(g)&&g($self):(f.callBack||(f.callBack=function(b){e.tinyscrollbarCallBack&&a.isFunction(e.tinyscrollbarCallBack)&&e.tinyscrollbarCallBack($self,b)}),a.spice.tools.tinyscrollbar({elem:c,options:f,isIscroll:e.isIscroll}))}),b.on("tap","li",function(b,g){var h=a(this),i=h.parent(),j=+i.attr("ymd-index"),k=h.attr("ymd-value");h.addClass("selected").siblings().removeClass("selected"),i.removeAttr("ymd-curval");var l=a("span:eq(0)",h.closest(".sub-menu").prev());if(l.html()==k)return d.hide(e.btnAddClass),!1;e.defaultError&&!g&&(k?h.closest(".form-select").removeClass("is-error").addClass("is-success"):h.closest(".form-select").addClass("is-error").removeClass("is-success"),c.elem[-1==a.inArray(!0,c.isError())?"removeClass":"addClass"]("is-error"),c.elem[-1==a.inArray(!0,c.isError())?"addClass":"removeClass"]("is-success")),l.html(h.text()),d.hide(e.btnAddClass),++j;var m=a("[ymd-index="+j+"]",f),n=m.attr("ymd-curval");if(0==m.length)return e.callBack&&a.isFunction(e.callBack)&&e.callBack(d.getSimulationSelectVal(e,f),f,g),!1;m.html(d.getOptionHtml(j,n,c));var o=a("li.selected",m);0==o.length&&(o=a("li:eq(0)",m)),o.trigger("tap",[g])})},getDefaultSelectVal:function(b){return a.map(a("select",b),function(b){return a("option:selected",b).attr("value")})},activate:function(a,b){b.isDefault?d.defaultSelect(a,b):d.simulationSelect(a,b)},leapYear:function(a){if(a%100==0){if(a%400==0)return!0}else if(a%4==0)return!0;return!1},getOptionStr:function(a,b,c,d){return c.isDefault?d?c.opt.defaultText?'<option value="">'+a+"</option>":"":'<option value="'+a+'" '+(b==a?"selected":"")+">"+a+"</option>":d?c.opt.defaultText?'<li ymd-value=""><a>'+a+"</a></li>":"":'<li ymd-value="'+a+'"'+(b==a?' class="selected"':"")+"><a>"+a+"</a></li>"},getOptionHtml:function(b,c,e){var f="",g=e.opt,h=e.isDefault?d.getDefaultSelectVal(e.elem):d.getSimulationSelectVal(g,e.elem),i=+h[0],j=+h[1];if(f=d.getOptionStr(g.defaultText[b]||"",c,e,!0),0===b&&a.isArray(g.year)&&2==g.year.length){var k=g.year[0],l=g.year[1],m=l+1;if(k<=l)for(;m-- >g.year[0];)f+=d.getOptionStr(m,c,e)}else if(1===b){if(i)for(var j=0;++j<=12;)f+=d.getOptionStr(j,c,e)}else if(2===b){var n=0,o=0;if(i&&j)for(o=2==j?d.leapYear(i)?29:28:-1!=a.inArray(j,[1,3,5,7,8,10,12])?31:30;++n<=o;)f+=d.getOptionStr(n,c,e)}return f}},e=function(b,d){var e=this;e.opt=a.extend({},c,d),e.elem=b,e.init()};e.prototype={init:function(){var b=this,c=b.opt,e=b.isDefault=!(c.btnClass&&c.contentClass);if(e?b.select=a("select",b.elem):(b.select=a(c.contentClass,b.elem),b.pcdBtn=a(c.btnClass,b.elem)),0==b.select.length)return!1;if(a.each(b.select,function(c,e){var f=a(e),g=f.attr("ymd-curval");f.attr({"ymd-index":c}).html(d.getOptionHtml(c,g,b)),d.activate(f,b)}),e)b.select.eq(0).trigger("change",["default"]);else{var f=a("li.selected",b.select.eq(0));0==f.length&&(f=a("li:eq(0)",b.select.eq(0))),f.trigger("tap",["default"]),a("html").on("tap",function(b){var e=a(b.target);e.hasClass("form-select")||0!=e.parents(".form-select").length||d.hide(c.btnAddClass)})}},getSelectVal:function(){return this.isDefault?d.getDefaultSelectVal(this.elem):d.getSimulationSelectVal(this.opt,this.elem)},setSelectVal:function(b){if(!a.isArray(b)||0==b.length)return!1;if(this.select){this.select.attr("ymd-curval",function(){return b[a(this).attr("ymd-index")]});var c=null;this.isDefault?(a("option",this.select.eq(0)).removeAttr("selected"),c=a("option:contains("+b[0]+")",this.select.eq(0)),0===c.length&&(c=a("option[value="+b[0]+"]",this.select.eq(0))),c.attr("selected","selected"),this.select.eq(0).trigger("change",["default"])):(a("li",this.select.eq(0)).removeAttr("class"),c=a("li:contains("+b[0]+")",this.select.eq(0)),0===c.length&&(c=a("li[ymd-value="+b[0]+"]",this.select.eq(0))),c.addClass("selected").trigger("tap",["default"]))}},isError:function(){var b=[];return a.each(this.getSelectVal(),function(a,c){b.push(!c.split("-")[0])}),b}},a.spice.ymdSelect=b}(jQuery);
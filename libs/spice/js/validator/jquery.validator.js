!function(a){"use strict";function b(b,c){if(!b||a.isPlainObject(b))return!1;var e=[];return a(b).each(function(b,f){var g=a(f),h=g.data("spice.validator");h&&h.destroy(),g.data("spice.validator",h=new d(g,c)),e.push(h)}),e}var c={submitBtn:".spice-form-btn-submit",formGroup:".spice-form-group",validateAttr:"spice-data-term",errorBlockClass:".spice-msg-block > span",errorAddClass:"spice-error",successAddClass:"spice-success"},d=function(b,d){var e=this;e.opt=a.extend({},c,d),e.elem=b,e.init()};d.prototype={init:function(){var b=this,c=b.opt,d=b.elem;b.validateElem(),a(c.submitBtn,d).on("tap",function(){a("["+c.validateAttr+"]",d).trigger("keyup.spice-keyup").trigger("radio.spice-radio").trigger("change.spice-change").trigger("checkbox.spice-checkbox"),a("select",a("["+c.validateAttr+"]",d)).trigger("change.spice-change"),a("li.spice-current",a("["+c.validateAttr+"]",d)).trigger("tap.spice-change"),a(this).trigger("spice.validator-submit")})},getErrorElem:function(){return a("."+this.opt.errorAddClass,this.elem)},getDataTerm:function(b){var c=b.attr(this.opt.validateAttr);return!!c&&a.parseJSON(c)},validateElem:function(){var b=this,c=this.opt,d=a(c.formGroup,this.elem);a.each(d,function(e,f){var g=a(f),h=a("["+c.validateAttr+"]",g);if(0!=h.length){var i=h[0].tagName,j={$elemBox:g,$validateElem:h,$errorBlock:a(c.errorBlockClass,g),$elem:d};if("INPUT"==i){var k=h.attr("type");"text"==k||"password"==k?b._validateInputText(j):"radio"==k?b._validateInputRadio(j):"checkbox"==k&&b._validateInputCheckbox(j)}else"TEXTAREA"==i?b._validateInputText(j):"SELECT"==i?b._validateSelect(j):h.hasClass("spice-dropdown")&&b._validateSelect(j)}})},_removeError:function(a){a.$elemBox.removeClass(this.opt.errorAddClass),a.$errorBlock.html("")},_setErrorMsg:function(a,b){var c=this,d=c.opt;b?(a.$elemBox.addClass(d.errorAddClass),a.$elemBox.removeClass(d.successAddClass),a.$validateElem.trigger("spice.validator-error")):(a.$elemBox.removeClass(d.errorAddClass),a.$elemBox.addClass(d.successAddClass),a.$validateElem.trigger("spice.validator-success")),a.$errorBlock.html(b)},_validateInputText:function(b){var c=this,d=c.opt,e=b.$validateElem;if(0==e.length)return!1;var f=c.getDataTerm(e);b=a.extend(b,{placeholder:a.trim(e.attr("placeholder")),dataTerm:f,minlength:+f.minlength,maxlength:+f.maxlength,pattern:f.pattern,required:f.required,match:a.trim(f.match),type:f.type,errorStandard:f.errorStandard,errorPattern:f.errorPattern,errorLength:f.errorLength,errorMatch:f.errorMatch}),"mobile"==b.type&&(b.pattern=b.pattern||"^(1[3-9]{1}[0-9]{1})\\d{8}$"),"email"==b.type&&(b.pattern=b.pattern||"^(\\w-*\\.*)+@(\\w-?)+(\\.\\w{2,})+$"),b.$validateElem.on("focus.spice-focus",function(){a(this).trigger("spice.validator-focus",a(this))}).on("keyup.spice-keyup blur.spice-blur",function(e){var f=a(this),g=a.trim(f.val()),h="";if(!b.dataTerm)return!1;if(g&&g!=b.placeholder){if((g.length<b.minlength||g.length>b.maxlength)&&!b.match)h=b.errorLength||b.errorStandard;else if(b.pattern&&!b.match){var i=new RegExp(b.pattern);i.test(g)||(h=b.errorPattern||b.errorStandard)}else if(b.match){var j=a(b.match,b.$elem.parent()),k=j.val();g!=k&&(h=b.errorMatch)}}else h=b.errorStandard;if(!(Boolean(b.required)||g&&g!=b.placeholder))return c._removeError(b),b.$elemBox.removeClass(d.errorAddClass).removeClass(d.successAddClass),!1;c._setErrorMsg(b,h),f.trigger("spice.validator-"+e.type)})},_validateInputRadio:function(b){var c,d=this,e=d.opt,f=b.$validateElem;if(0==f.length)return!1;var g=d.getDataTerm(f),h=f.attr("name"),i=a("input[type=radio][name="+h+"]",d.elem);f.on("radio.spice-radio",function(a){if(Boolean(g.required)){i.filter(":checked").length<=0?(c=g.errorStandard,d._setErrorMsg(b,c),b.$validateElem.trigger("spice.validator-error")):(d._removeError(b),b.$validateElem.trigger("spice.validator-success"))}}),i.on("tap",function(){var c=a(this);c.attr("name");i.filter(":checked").length>0&&(d._removeError(b),b.$elemBox.addClass(e.successAddClass),b.$validateElem.trigger("spice.validator-success"))})},_validateSelect:function(b){var c=this,d=c.opt,e=b.$validateElem;if(0==e.length)return!1;var f=c.getDataTerm(e),g=e,h=a("select",e),i=a("li",e),j=function(h){var i=a.trim(h.val()),j="",k=g.length,l=g.filter(function(){return a.trim(a(this).val())}).length,m=h.closest(".spice-dropdown"),n=m.length>0?m:h;if("LI"==h[0].tagName&&(g=a("li.spice-current",e),i=h.attr("spice-data-value"),k=g.length,l=g.filter(function(){return a(this).attr("spice-data-value")}).length),0==l&&!Boolean(f.required))return e.removeClass(d.errorAddClass).removeClass(d.successAddClass),c._removeError(b),b.$elemBox.removeClass(d.errorAddClass).removeClass(d.successAddClass),e.trigger("spice.validator-success"),!1;l!=k&&0!=l||Boolean(f.required)&&!i?(j=f.errorStandard,c._setErrorMsg(b,j),i?(n.removeClass(d.errorAddClass),n.addClass(d.successAddClass)):(n.addClass(d.errorAddClass),n.removeClass(d.successAddClass))):(n.removeClass(d.errorAddClass),n.addClass(d.successAddClass),c._setErrorMsg(b,j),c._removeError(b))};if(i.length>0)return g=i,e.on("tap.spice-change","li",function(){j(a(this))}),!1;h.length>0&&(g=h),g.on("change.spice-change",function(b){j(a(this))})},_validateInputCheckbox:function(b){var c,d=this,e=d.opt,f=b.$validateElem;if(0==f.length)return!1;var g=d.getDataTerm(f);f.on("checkbox.spice-checkbox",function(a){Boolean(g.required)&&(f.is(":checked")?(d._removeError(b),b.$validateElem.trigger("spice.validator-success")):(c=g.errorStandard,d._setErrorMsg(b,c)))}),f.on("tap",function(){var f=a(this);Boolean(g.required)?(f.is(":checked")?(c="",d._removeError(b)):c=g.errorStandard,d._setErrorMsg(b,c)):(b.$elemBox.removeClass(e.errorAddClass)[f.is(":checked")?"addClass":"removeClass"](e.successAddClass),b.$validateElem.trigger("spice.validator-success"))})}},a.spice.validator=b}(jQuery);
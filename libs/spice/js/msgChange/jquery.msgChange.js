/**
 *
 * 信息切换
 * 详细用法请参考：http://v3.spice.lh/javascript/msgChange
 * 如果链接无法访问，请联系QQ：1515110755 或 RTX：hong.liang
 *
 * @ author Razy 
 * @ version 1.0
 *
 */
!function(a){"use strict";function b(b,c){if(!b||a.isPlainObject(b))return!1;var d={};return a(b).each(function(b,f){var g=a(f),h=g.data("spice.msgChange");h=new e(g,c),d[b]=h}),1==a(b).length&&(d=d[0]),d}var c={termsObj:"",imageSrc:"",changeType:"color",typeAttr:"data-type",valueAttr:"data-value",typeSetAttr:"data-set-value",disabledClass:"is-disabled",currentClass:"is-selected",lineClass:"msg-line",stockClass:"events-calculate-num",cloudZoomClosestClass:".events-detail-img",cloudZoom:null},d={getImgUrl:function(a,b){return a.small||"number"!=typeof b?a:{small:a[1].content[b].small,middle:a[0].content[b].medium,big:a[0].content[b].standard}},getCloudzoom:function(a,b,c){var e=d.getImgUrl(a,c);return'<img class="" src="'+e.middle+'" data-cloudzoom="zoomImage: \''+e.big+"'\" />"},getThumList:function(b,c){return a.map(b[1].content,function(a,c){var e=d.getImgUrl(b,c),f=JSON.stringify(e);return"<li"+(0==c?' class="is-selected"':"")+" data-img-src='"+f+'\'>                            <a class="thumbnail">                                <img src="'+a.small+'" />                            </a>                            <i></i>                        </li>'}).join("\n")},getTemplate:function(a,b){return"<a>"+d.getCloudzoom(a,b,0)+'</a>                    <div class="scroll scroll-gallery">                        <div>                            <ul>'+d.getThumList(a,b)+"</ul>                        </div>                    </div>"}},e=function(b,d){var e=this;e.opt=a.extend({},c,d),e.elem=b,e.init()};e.prototype={init:function(){var b=this,c=b.opt;if(!c.termsObj||a.isEmptyObject(c.termsObj))return!1;b.tapElemList=b.getTapElemList(),b.initElemStatus(),b.tapElemList.off("tap").on("tap",function(){var e=a(this),f=e.attr(c.typeAttr),g=e.attr(c.valueAttr),h=e.parent().find("."+c.currentClass).attr(c.valueAttr);if(e.hasClass(c.disabledClass))return!1;e.toggleClass(c.currentClass).siblings().removeClass(c.currentClass),f==c.changeType&&h!=g&&(a(c.cloudZoomClosestClass,b.elem).html(d.getTemplate(c.imageSrc[g],b)),b.init());var i=a("."+c.stockClass,b.elem),j=a("input",i),k=i.data("spice.calculateNum");b.calculateMax=k.opt.max,j.val(k?k.opt.min:1),b.elem.trigger("spice.msgChange-tap",{self:b,data:b.initElemStatus(),tapElem:e,type:f,value:g,selectList:b.getSelected()})});var e=a(c.cloudZoomClosestClass+" li",b.elem);e.off("tap").on("tap",function(){var e=a(this),f=(e.index(),e.attr("data-img-src")),g=a.parseJSON(f);a(">a:eq(0)",e.closest(c.cloudZoomClosestClass)).html(d.getCloudzoom(g,b)),b.opt.cloudZoom&&a.isFunction(b.opt.cloudZoom)&&b.opt.cloudZoom("[data-cloudzoom]"),e.addClass(c.currentClass).siblings().removeClass(c.currentClass),b.elem.trigger("spice.msgChange-thumb",{self:b,tapElem:e})}),e.eq(0).trigger("tap")},getSelected:function(){return a("."+this.opt.lineClass+" ."+this.opt.currentClass,this.elem)},getSelectedValue:function(){var b=this;return a.map(b.getSelected(),function(c,d){return a(c).attr(b.opt.valueAttr)})},getTapElemLine:function(){var b=this,c=b.opt;return a("."+c.lineClass,b.elem).filter(function(){return b.getTapElemList(this).length>0})},getTapElemList:function(b){return a("["+this.opt.typeAttr+"]["+this.opt.valueAttr+"]",b||this.elem)},_dataStock:{},_dataChangeObj:{},initElemStatus:function(){var b=this,c=b.opt,d=b.getSelected(),e=[],f={changeObj:{},newStock:{}},g=b._dataStock,h=b._dataChangeObj;if(0!=d.length){a.each(d,function(b,d){e.push(a(d).attr(c.valueAttr))});var i=e.join(";");g[i]?(f.newStock=g[i],f.changeObj=h[i]):(a.each(c.termsObj,function(d,g){a.each(d.split(";"),function(h,i){var j=a("["+c.valueAttr+'="'+i+'"]',b.elem),k=j.siblings("."+c.currentClass),l=k.attr(c.valueAttr),m=[],n=0==k.length?e:a.spice.difference(e,[l]);a.each(n,function(a,b){m.push(d.indexOf(b)>=0)}),m=-1==a.inArray(!1,m),0==k.length?m&&(f.changeObj[d]=g,f.newStock[i]=(f.newStock[i]||0)+parseInt(g.stock)):(0==n.length||m)&&(f.newStock[i]=(f.newStock[i]||0)+parseInt(g.stock))})}),g[i]=f.newStock,h[i]=f.changeObj),a.each(f.newStock,function(d,e){0==e?a("["+c.valueAttr+'="'+d+'"]',b.elem).addClass(c.disabledClass):a("["+c.valueAttr+'="'+d+'"]',b.elem).removeClass(c.disabledClass)});var j=f.newStock[e[0]];return j>b.calculateMax?a("."+b.opt.stockClass,b.elem).removeAttr("data-stock"):a("."+c.stockClass,b.elem).attr("data-stock",j),b.setValue(f.changeObj),f}b.tapElemList.removeClass(c.disabledClass)},setValue:function(b){var c=this;a.each(b,function(b,d){a.each(d,function(b,e){var f=a.trim(d.price),g=a.trim(d.salePrice);"price"==b||"salePrice"==b?g&&f!=g?a("["+c.opt.typeSetAttr+'="price"]',c.elem).html(g+"<del>"+f+"</del>"):a("["+c.opt.typeSetAttr+'="price"]',c.elem).html(f):a("["+c.opt.typeSetAttr+'="'+b+'"]',c.elem).html(e)})})},destroy:function(){var a=this;a.tapElemList.off("tap"),a.tapElemList.removeClass(a.opt.disabledClass).removeClass(a.opt.currentClass)}},a.spice.msgChange=b}(jQuery);